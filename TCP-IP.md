# TCP/IP整理

TCP/IP协议的工作流程如下：

●在源主机上，应用层将一串应用数据流传送给传输层。

●传输层将应用层的数据流截成分组，并加上TCP报头形成TCP段，送交网络层。

●在网络层给TCP段加上包括源、目的主机IP地址的IP报头，生成一个IP数据包，并将IP数据包送交链路层。

●链路层在其MAC帧的数据部分装上IP数据包，再加上源、目的主机的MAC地址和帧头，并根据其目的MAC地址，将MAC帧发往目的主机或IP路由器。

●在目的主机，链路层将MAC帧的帧头去掉，并将IP数据包送交网络层。

●网络层检查IP报头，如果报头中校验和与计算结果不一致，则丢弃该IP数据包；若校验和与计算结果一致，则去掉IP报头，将TCP段送交传输层。

●传输层检查顺序号，判断是否是正确的TCP分组，然后检查TCP报头数据。若正确，则向源主机发确认信息；若不正确或丢包，则向源主机要求重发信息。

●在目的主机，传输层去掉TCP报头，将排好顺序的分组组成应用数据流送给应用程序。这样目的主机接收到的来自源主机的字节流，就像是直接接收来自源主机的字节流一样。

## 网络命令

1、ipconfig的作用是什么？

显示当前的TCP/IP配置的设置值

2、运行net share　返回的结果是什么？

列出共享资源相关信息 如 IPC$

3、net use 和net user分别是指什么？

net user 用于用户管理，添加，删除网络使用用户。
net use 用于网络设备管理，例如添加磁盘

4、如何在命令行下面查看当前系统开放的服务？

   在命令行下执行net services 命令

5、除以上命令，还有哪些，请写出你知道的命令。

   taskill
   taslist
   net view显示计算机列表
   netstat
   ftp
   telnet

## 系统端口及服务

　1、关掉以下服务，会出现什么样的情况，并请说明你的看法。

Automatic Updates　

不能自动更新

Plug and Play

禁用会导致USB不能使用.

Remote Registry Service

防范通过浏览网页来修改你的注册表

Computer Browser

无法通过该服务维护网络上计算机的最新列表以及提供这个列表给请求的程序。

2．端口及相对的服务

FTP（21 文件传输FTP服务　　　）

Terminal Services　的端口是（　3389　　　）

23端口是（TELNET）开放的默认端口

25端口是（E-mail SMTP）开放

109端口是（　　POP2　）开放

1433端口是（　　SQL Server　　　）开放

## 网络协议

ICMP：
是Internet Control Message Protocol（Internet控制消息协议）的缩写。
它是TCP/IP协议族的一个子协议，用于在IP主机、路由器之间传递控制消息。
控制消息是指网络通不通、主机是否可达、路由是否可用等网络本身的消息。
这些控制消息虽然并不传输用户数据，但是对于用户数据的传递起着重要的作用。

TFTP：
Trivial File Transfer Protocol,是TCP/IP协议族中的一个用来在客户机与服务器之间进行简单文件传输的协议
提供不复杂、开销不大的文件传输服务。　　

HTTP：
HTTP超文本传输协议，是一个属于应用层的面向对象的协议，由于其简捷、快速的方式，适用于分布式超媒体信息系统，
它于1990年提出，经过几年的使用与发展，得到不断地完善和扩展。

DHCP：动态主机配置协议， 是一种让系统得以连接到网络上，并获取所需要的配置参数手段

# TCP/IP 基础知识

## 分组技术

- 可以让多个用户共享一条线路

## tcp/ip 代表什么

- 利用 IP 进行通信时所必须用到的协议群的统称
- RFC 协议的说明，STD 管理 RFC

## 互联网结构

- 互联网由很多较小范围的网络组成，每个小网由骨干网和末端网组成

## TCP/IP 协议分层模型

- 物理层将二进制的0和1和电压高低，光的闪灭和电波的强弱信号进行转换
- 链路层代表驱动
- 网络层
    - 使用 IP 协议，IP 协议基于 IP 转发分包数据
    - IP 协议是个不可靠协议，不会重发
    - IP 协议发送失败会使用ICMP 协议通知失败
    - ARP 解析 IP 中的 MAC 地址，MAC 地址由网卡出厂提供
    - IP 还隐含链路层的功能，不管双方底层的链路层是啥，都能通信
- 传输层
    - 通用的 TCP 和 UDP 协议 
        - TCP 协议面向有连接，能正确处理丢包，传输顺序错乱的问题，但是为了建立与断开连接，需要至少7次的发包收包，资源浪费
        - UDP 面向无连接，不管对方有没有收到，如果要得到通知，需要通过应用层
- 会话层以上分层
    - TCP/IP 分层中，会话层，表示层，应用层集中在一起
    - 网络管理通过 SNMP 协议

## TCP/IP 分层模型与通信示例

- 发包过程 
    - 表示层转码，会话层决定何时建立连接，传输层负责建立连接，断开连接和发送数据，保证数据能顺利发送至对端。TCP 协议（传输层）在数据前附加一个首部，这个首部除了包含发送端和接收端地址以外，还包含序号，检验和（判断数据是否被破坏）。IP （网络层）模块将 TCP 传来的首部和数据当数据。加首部，这个首部中包含地址和上一层的协议。链路层除了添加首部，还会添加 FCS 到包尾
- 收包过程 
    - 链路层判断 MAC 地址，判断IP 协议。网络层做的事情差不多，在这里，对于有路由器的情况下，借助路由控制表，在找到应该送达的主句或路由器以后再转发数据。传输层检验数据是否被损坏，检验数据是否按照顺序发送，然后再做相同的事情

# 数据链路层

## 数据链路的作用

- 链路层将数据集合为一个帧的块，然后进行传输
- 只提供导线一端到另一端的传输

## MAC 地址

- Mac 地址长48比特，被烧入到网卡 ROM 中，不会重复

## 交换机

- 交换机自学然后生成一张 Mac 表，具体原理为 
    - 交换机4个端口连接着终端，A 终端与端口1连接，发送 frame 后交换机得知端口1和 A 终端的关系，然后转发到其他三端，转发完成后得知端口2与主机 B 想对应，记录到表中。以后主机 A 与主机 B 的通信就通过端口1和端口2进行

## 帧 frame

- 帧是“一个数据链路层的传输单元，由一个数据链路层首部和其携带的分组所组成”。譬如说以太网帧，PPP 帧

## 以太网帧结构



![img](https:////upload-images.jianshu.io/upload_images/874828-2e3f5e20c92ff21f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp)

以太网帧结构

- 一个帧以7个字节的前导码和1个字节的帧开始符作为帧的开始
- 抱头包含源和目标的 Mac 地址和表明上一层网络协议的类型
- 接下来是数据
- 后面是帧验证序列，以验证帧是否损坏
- 最后有一个帧间距，两个帧发送间要再发送至少12字节的空闲线路状态码

# IP 协议

## 网络层作用

- 跨越多种数据链路传输数据包
- 提供路由和寻址功能

## IP 地址

- 每块网卡需配置至少一个 IP 地址
- IP 地址由32位正整数组成，为二进制，但是为了人类更好的阅读，将他每8位分为一组，共4组
- IP 地址由网络和主机两标识组成 
    - 网络标识在数据链路的每个段配置不同的值，必须保证相互连接的端的地址不重复
    - 主机标识不允许在同一网段内重复
- IP 地址分为四个级别，分别为 A, B, C, D 
    - A类地址是首位为 0 开头，前八位是网络标识， 0.0.0.0 ~ 127.0.0.0属于 A 类
    - B 类地址是前两位由 10 组成，前16位是网络标识，128.0.0.0 ~ 191.255.0.0 属于 B 类
    - C 类地址前三位是 110， 前24位是网络标识，192.0.0.0 ~ 239.255.255.0 属于 B 类
    - D 类前四位是 1110，32位全是网络标识，224.0.0.0 ~ 239.255.255.255属于 D 类
- 但是以上的分类已经不用，改为使用子网掩码定位网络标识长度。 
    - 子网标识同一个网关，255.255.255.0和255.255.255.1是同一个子网
    - 子网掩码也是32位组成
    - 掩码中有几个1就代码几位网络标识，其他为主机标识
    - 假如掩码前24位为1，就代表前24位都为网络标识，用 IP 地址标识就是255.255.255.0，后面的0代表主机标识，理论上有256台主机可连接

## 路由控制

- 仅有 IP 地址还不足以将数据包发送到对端，还需指明路由器或主机。保存这种信息的就是路由控制表。
- 路由控制表中记录着地址与下一步要发送至路由器的地址。在发送 IP 包时，先确定 IP 包首部目标地址，然后在表中找到与该地址具有相同网络地址的记录，根据记录将 IP 包转发给相应的下一个路由器。

## IPv6

- 地址长度为128位
- 解决了很多 IPv4的问题 
    - IP 地址扩大（目前 IPv4地址不足的问题由 NAT解决，NAT 是一种在 IP 数据包通过路由器或防火墙时重写源 IP 地址或目标地址的技术。这种技术被用于多台主机使用单个公有 IP 访问互联网的私有网络中。）
    - 包首部长度固定40字节，路由器不在做分片操作，直接在发送端主机分片
    - 不需 DHCP 服务器也能自动分配 IP地址
    - 使用认证和加密功能

# IP协议相关技术

## DNS

- IP 地址不容易记忆，然后出现了域名。DNS 是将域名和 IP 地址相互映射的一个分布式数据库。
- DNS 解析 
    - 查询 [www.baidu.com](https://link.jianshu.com?t=http://www.baidu.com) ，DNS 服务器会先检查自身缓存，有记录则返回结果
    - 记录不存在，DNS 服务器向根域名服务器查询，然后会返回.com 域的权威域名服务器地址
    - DNS 向 .com 服务器查询，得到 .baidu.com 地址
    - DNS 向 .baidu.com 服务器查询，得到最终地址，存入缓存并返回结果

## ARP

- 以太网协议规定两台主机相互通信必须知道目标主机 MAC 地址
- 数据链路层会将上一层 IP 协议发来的 IP 地址转为 MAC 地址
- 如果两台主机不在同一个局域网内，必须通过路由转发才能通信。此时，发送端通过 ARP 获得的 MAC 地址是一台可以通向局域网外的路由器的 MAC 地址
- IPv6解析 MAC 地址通过 NDP

## NAT

- 用于在本地网络中使用私有地址，连接互联网时转为全局 IP 地址的技术 
    - 本地地址10.0.0.10要向163.221.120.9通信
    - NAT  路由器会将发送源地址从10.0.0.10转为全局 IP 地址202.244.174.37再通信
- 当一个公有 IP 下有多台主机需要对外通信时，如果多台主机都使用相同的端口号会导致转为全局 IP 时数字一致，所有通过 NAPT 技术可以给转换端口号 
    - NAT 路由器会自动生成 NAPT 的转换表，这个转换表可以正确转换地址和端口的组合
    - 在 TCP 中，简历 TCP 连接首次握手时的 SYN 包发出后就会生成表。在收到关闭连接时发出的 FIN 包时删除

# TCP 与 UDP

## 传输层协议

TCP 和 UDP 是传输层的两个具有代表意义的协议.

TCP 是面向有链接的,可靠的协议,TCP 建立连接需要三次握手,断开连接需要四次握手.因为效率比不上 UDP 协议.但是 TCP 协议具有重发包，顺序控制等的机制。

UDP 是面向无连接的协议，不提供复杂的控制机制。做的最重要的事情就是分辨应用层协议。多用于视频音频通讯。

传输层的作用是指出具体该把数据包发给哪个应用，通过端口来分辨应用。

## 端口号

同一个端口不会同时出现，传输层通过辨认端口号来确认应用。但是只靠端口号识别通信是不够的。需要采取五个信息来识别一个通信，分别是源 IP 地址，目标 IP 地址，协议号，源端口号，目标端口号。两个包中只要任何一个信息不同就不是同一个通信。

## TCP

### 三次握手建立连接

主机 A 相与主机 B 建立连接，主机 A 会首先发送一个 SYN 包给主机 B。主机 B 会返回 确认应答 ACK 或者否定应答 NACK。如果这时主机 A 长时间没有收到主机 B 的应答，主机 A 会重发 SYN 包给主机 B，实现了重发数据包的功能。当主机 B 发送 ACK 给主机 A 后，主机 A 也会发送一个 ACK 包给主机 B，这时建立连接。

TCP有顺序控制的功能，通过一个序列号来确认发送的数据。在发送 SYN 包前，假设主机 A 的初始序列号为1000，以该序号依次往下进行数据编号，然后告诉主机 B 初始序列，同时主机 B 会对 A 的序列号进行确认，假如主机 B 返回一个2000的序列号，则代表字节编号为1000 — 1999，表明主机 B 收到1000字节。

### 为什么不是两次握手

两次握手就建立连接，假如主机 A 发送的 SYN 因网络问题迟迟没有到达主机 B，这时候会重发另一个 SYN 包给 B，当 A 接受到 B 的 ACK 包时建立连接。这时如果第一个 SYN 到达 B 时，主机 B 会认为主机 A 希望再次建立连接，会返回一个 ACK 包给 A。当 A 收到 ACK 时会抛弃掉这个包，因为 A 并不想建立连接，这时主机 B 认为连接已经建立，会一直等待主机 A 发送数据，这样会导致主机 B 的性能损耗。

### 四次握手断开连接

主机 A 发送 FIN（请求切断连接），主机 B 收到后回复 ACK 和 FIN 包，主机 A 收到主机 B 的 FIN  和 ACK 后发送 ACK 包

### TCP首部



![img](https:////upload-images.jianshu.io/upload_images/874828-73b0a7228138f337.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/630/format/webp)

​                                                                                TCP首部

序列号码

- 如果含有 SYN，则此为最初序列号
- 如果没有 SYN，则此为第一个数据字节的序列号

确认号码，期望收到的数据的开始序列号。

检验和，对整个 TCP 报文段，包括头部和数据以16位字进行计算所得，这时一个强制性字段

## UDP头部



![img](https:////upload-images.jianshu.io/upload_images/874828-d17a871a92ed5452.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp)

​                                                                                 UDP头部

报文长度，指定 UDP 报头和数据总共占用的长度。

检验和，用于发现头部信息和数据中的传输错误，该字段在 IPv4中可选， IPv6中强制。

**TCP三次握手和四次挥手？**

被问烂了的问题了，这里不详细讲了，三次握手：

- 客户端–发送带有SYN标志的数据包–一次握手–服务端
- 服务端–发送带有SYN/ACK标志的数据包–二次握手–客户端
- 客户端–发送带有带有ACK标志的数据包–三次握手–服务端

四次挥手：

- 客户端-发送一个FIN，用来关闭客户端到服务器的数据传送
- 服务器-收到这个FIN，它发回一个ACK，确认序号为收到的序号加1 。和SYN一样，一个FIN将占用一个序号
- 服务器-关闭与客户端的连接，发送一个FIN给客户端
- 客户端-发回ACK报文确认，并将确认序号设置为收到序号加1

## HTTP

Http协议是建立在TCP协议基础之上的，当浏览器需要从服务器获取网页数据的时候，会发出一次Http请求。Http会通过TCP建立起一个到服务器的连接通道，当本次请求需要的数据完毕后，Http会立即将TCP连接断开，这个过程是很短的。所以Http连接是一种短连接，是一种无状态的连接。

所谓的无状态，是指浏览器每次向服务器发起请求的时候，不是通过一个连接，而是每次都建立一个新的连接。如果是一个连接的话，服务器进程中就能保持住这个连接并且在内存中记住一些信息状态。而每次请求结束后，连接就关闭，相关的内容就释放了，所以记不住任何状态，成为无状态连接。

### http传输流

无耻盗图



![img](https://user-gold-cdn.xitu.io/2018/4/17/162d19df66466f6b?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



发送端在层与层间传输数据时，没经过一层都会被加上首部信息，接收端每经过一层都会删除一条首部

状态码就那些，常用的记住就行了：

2XX 成功

- 200 OK，表示从客户端发来的请求在服务器端被正确处理
- 204 No content，表示请求成功，但响应报文不含实体的主体部分
- 206 Partial Content，进行范围请求

3XX 重定向

- 301 moved permanently，永久性重定向，表示资源已被分配了新的 URL
- 302 found，临时性重定向，表示资源临时被分配了新的 URL
- 303 see other，表示资源存在着另一个 URL，应使用 GET 方法丁香获取资源
- 304 not modified，表示服务器允许访问资源，但因发生请求未满足条件的情况
- 307 temporary redirect，临时重定向，和302含义相同

4XX 客户端错误

- 400 bad request，请求报文存在语法错误
- 401 unauthorized，表示发送的请求需要有通过 HTTP 认证的认证信息
- 403 forbidden，表示对请求资源的访问被服务器拒绝
- 404 not found，表示在服务器上没有找到请求的资源

5XX 服务器错误

- 500 internal sever error，表示服务器端在执行请求时发生了错误
- 503 service unavailable，表明服务器暂时处于超负载或正在停机维护，无法处理请求

**HTTP协议格式？**

HTTP的请求和响应的消息协议是一样的，分为三个部分，起始行、消息头和消息体。这三个部分以CRLF作为分隔符。最后一个消息头有两个CRLF，用来表示消息头部的结束。



![img](https://user-gold-cdn.xitu.io/2018/4/17/162d1a89a0707473?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



HTTP请求的起始行称为请求行，形如GET /index.html HTTP/1.1

HTTP响应的起始行称为状态行，形如200 ok

消息头部有很多键值对组成，多个键值对之间使用CRLF作为分隔符，也可以完全没有键值对。形如Content-Encoding: gzip 消息体是一个字符串，字符串的长度是由消息头部的Content-Length键指定的。如果没有Content-Length字段说明没有消息体，譬如GET请求就是没有消息体的，POST请求的消息体一般用来放置表单数据。GET请求的响应返回的页面内容也是放在消息体里面的。我们平时调用API返回的JSON内容都是放在消息体里面的。

**HTTP的无状态性？**

所谓HTTP协议的无状态性是指服务器的协议层无需为不同的请求之间建立任何相关关系，它特指的是协议层的无状态性。但是这并不代表建立在HTTP协议之上的应用程序就无法维持状态。应用层可以通过会话Session来跟踪用户请求之间的相关性，服务器会为每个会话对象绑定一个唯一的会话ID，浏览器可以将会话ID记录在本地缓存LocalStorage或者Cookie，在后续的请求都带上这个会话ID，服务器就可以为每个请求找到相应的会话状态。

**输入url到页面加载都发生了什么事情？（最最常问的来了）**

- 输入地址
- 浏览器查找域名的 IP 地址 这一步包括 DNS 具体的查找过程，包括：浏览器缓存->系统缓存->路由器缓存...
- 浏览器向 web 服务器发送一个 HTTP 请求
- 服务器的永久重定向响应（从 http://example.com 到 http://www.example.com）
- 浏览器跟踪重定向地址
- 服务器处理请求
- 服务器返回一个 HTTP 响应
- 浏览器显示 HTML
- 浏览器发送请求获取嵌入在 HTML 中的资源（如图片、音频、视频、CSS、JS等等）
- 浏览器发送异步请求

**TCP/IP**，也就是互联网协议套件（英语：Internet Protocol Suite，缩写IPS）是一个**网络通信模型**，以及一整个**网络传输协议家族**，为网际网络的基础通信架构。

因为该协议家族的两个核心协议：TCP（传输控制协议）和IP（网际协议）为该家族中最早通过的标准，所以它常被通称为**TCP/IP协议族**，简称TCP/IP。

由于在网络通讯协议普遍采用分层的结构，当多个层次的协议共同工作时，类似计算机科学中的堆栈，因此又被称为**TCP/IP协议栈**。

TCP/IP提供点对点的链接机制，将数据应该如何封装、定址、传输、路由以及在目的地如何接收，都加以标准化。

它将软件通信过程抽象化为**四个抽象层**，采取协议堆栈的方式，分别实现出不同通信协议。

协议族下的各种协议，依其功能不同，被分别归属到这四个层次结构之中，常被视为是简化的**七层OSI模型**。

![tcp-ipOSI](https://www.jintix.com/static/uploads/png/20190327/24151f0f827fad11b252d848d527746a.png)

